# 订阅卡片操作闭环优化方案

## 阶段 0：需求确认与页面映射
- **目标**：明确所有动作的目标页面或模态形态，形成统一的路由/参数约定。
- **任务**：
  - 与业务确认“查看匹配课程”“加入已选课程”“通知详情”“编辑条件”“续期”等操作在最终流程中的归宿页面。
  - 梳理所需参数（如 `studentId`、`subscriptionId`、`courseCode`、`notificationId`），补齐订阅数据模型缺口。
  - 形成《订阅动作-页面映射表》，在团队内评审通过。
  - **已确认动作映射（第一批）**：
    - `edit`（编辑条件）：复用提交订阅时的“订阅条件设置”模态；若记录来源为“直接订阅”则不回填；其余字段按历史提交值回填。
    - `renew`（续期）：基于原截止日期顺延 180 天（格式 `YYYY-MM-DD`），写入续期历史并显示固定成功提示。
    - `cancel`（取消订阅）：新增订阅状态 `cancelled`，确认后更新卡片状态并清除学生数据中的“已订阅”标识，提示文案统一生成。
- **产出**：参数映射文档、路由约定表。
- **验收**：所有目标页面均有对应入口且参数定义一致。

## 阶段 1：数据准备与抽象
- **目标**：为跳转和编辑提供稳定的数据读取接口。
- **任务**：
  - 编写 `resolveSubscriptionContext(subscriptionId)`，统一拉取订阅详情、拼装标准数据包。
  - 若订阅数据缺少通知 ID、匹配结果 ID 等字段，扩展 `StudentRepository` 相关结构和写入逻辑。
  - 在渲染卡片时缓存必要字段（例如 `data-course-code`）。
- **产出**：数据上下文辅助函数、仓库层字段调整。
- **验收**：调用 `resolveSubscriptionContext` 可得到完整且类型安全的上下文对象。

## 阶段 2：导航基础设施搭建
- **目标**：提供统一的跳转/调度工具，简化后续功能实现。
- **任务**：
  - 新增 `navigateTo(target, params, options)` 助手，支持当前页跳转、新标签页、单页应用路由三种模式。
  - 定义 `actionRoutes` 常量，映射动作到目标路径及默认跳转方式。
  - 在跳转前后添加 Loading/错误提示处理，确保异常可见。
- **产出**：导航工具模块、动作到路由映射配置。
- **验收**：手动调用 `navigateTo` 能正确跳转并处理异常状态。

## 阶段 3：核心动作闭环实现
- **目标**：让卡片按钮完成真实跳转，支持数据透传。
- **任务**：
  - 在 `handleAction` 中接入 `navigateTo`，为 `jump`、`view`、`notifyDetail` 分支填充真实行为。
  - 缺参或无权限时给出友好提示；成功跳转后可选地记录用户行为日志。
  - 如目标页需懒加载数据，提供必要的查询 URL 示例。
- **产出**：可用的跳转逻辑、错误提示。
- **验收**：点击对应按钮能进入期望页面，浏览器控制台无报错。

## 阶段 4：编辑/续期交互优化
- **目标**：提供顺畅的条件编辑和续期体验。
- **任务**：
  - 方案 A：新增独立编辑页，通过 URL 参数加载原始订阅数据并可保存回仓库。
  - 方案 B：沿用订阅模态，支持 `mode: 'edit'`，自动回填字段并切换按钮文案。
  - 续期逻辑升级：引入日期选择组件／页面，保存后调用 `updateSubscription` 并刷新卡片。
  - 统一成功后的回调（刷新卡片、回到列表、展示 toast）。
- **产出**：编辑/续期界面或模态、更新后的仓库调用。
- **验收**：编辑与续期流程全程可操作，变更后卡片数据即时更新。

## 阶段 5：用户体验与异常兜底
- **目标**：弥补跳转过程中的边界场景，提升体验。
- **任务**：
  - 为未找到订阅/课程等场景加上兜底页面或提示。
  - 提供操作 Loading、成功/失败反馈（例如全局通知或 toast）。
  - 对跨域或登录态要求的页面提前校验，避免半路失败。
  - 记录关键操作日志，便于排查问题。
- **产出**：兜底策略文档、UI 反馈实现。
- **验收**：常见异常均有可感知提示，不会出现无响应状态。

## 阶段 6：联调、测试与交接
- **目标**：验证闭环流程，确保可交付。
- **任务**：
  - 编写测试用例：覆盖各按钮的主流程、参数缺失、权限不足等情况。
  - 与后端及目标页面团队联调 API/路由参数。
  - 完成操作手册或 README，指导使用与后续维护。
- **产出**：测试记录、操作手册、更新后的变更说明。
- **验收**：测试用例全部通过，文档齐备，团队成员了解新流程。
